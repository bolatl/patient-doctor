<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Кабинет пациента</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 40px; background: #fafafa; }
    .card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 24px;
      max-width: 420px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .row { display: flex; gap: 12px; align-items: center; margin-bottom: 10px; }
    label { width: 100px; font-weight: 500; }
    input { flex: 1; padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; }
    h2 { margin-top: 0; }
    button, .btn-link {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.15s ease;
    }
    button {
      background: #111;
      color: #fff;
    }
    button:hover {
      background: #222;
    }
    .btn-secondary {
      background: #f4f4f4;
      border: 1px solid #ccc;
      color: #222;
    }
    .btn-secondary:hover {
      background: #e9e9e9;
    }
    .muted { color: #666; font-size: 14px; margin-top: 10px; }
  </style>
  <script src="app.js"></script>
</head>
<body>
  <div class="card">
    <h2>Кабинет пациента</h2>

    <div id="login">
      <div class="row"><label>Логин</label><input id="loginInput" value="peter"></div>
      <div class="row"><label>Пароль</label><input id="passInput" type="password" value="1234"></div>
      <div class="row" style="gap:8px;">
        <button id="loginBtn">Войти</button>
        <a href="doctor.html" class="btn-secondary" style="text-decoration:none; display:inline-block; padding:8px 14px;">Я врач</a>
      </div>
      <p class="muted">Тестовые учётки: peter/1234 или aliya/1234</p>
    </div>

    <div id="panel" style="display:none">
      <p>Здравствуйте, <b id="pname"></b>! <button onclick="logout()">Выйти</button></p>
      <h3>Ваш выбранный врач</h3>
      <div id="docInfo" class="muted">Ещё не выбран.</div>

      <h3>Выбрать врача по ID</h3>
      <div class="row">
        <label>Врач</label>
        <select id="doctorSelect" style="flex:1; padding:8px; border-radius:8px; border:1px solid #ccc;"></select>
        <button id="chooseBtn">Сохранить</button>
      </div>
    </div>
  </div>

<script>
(async function(){
  const sess = loadSession();
  const $login = el("#login"), $panel = el("#panel");
  const $doctorSelect = el("#doctorSelect");
  const $docInfo = el("#docInfo");

  async function renderMe(id){
    const me = await api(`/api/patient/me?id=${id}`);
    el("#pname").textContent = me.patient.name;
    if(me.selected_doctor){
      const d = me.selected_doctor;
      $docInfo.textContent = `${d.last_name} ${d.first_name} ${d.middle_name} — ${d.speciality} (ID ${d.id})`;
    } else {
      $docInfo.textContent = "Ещё не выбран.";
    }
  }

  async function fillDoctors(){
    const docs = await api("/api/doctors");
    $doctorSelect.innerHTML = "";
    docs.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = `${d.last_name} ${d.first_name} (${d.speciality}) — ID ${d.id}`;
      $doctorSelect.appendChild(opt);
    });
  }

  if(sess && sess.role === "patient"){
    $login.style.display = "none"; $panel.style.display = "";
    await fillDoctors();
    await renderMe(sess.id);
  }

  el("#loginBtn").onclick = async () => {
    const login = el("#loginInput").value.trim();
    const password = el("#passInput").value.trim();
    const resp = await api("/api/login", "POST", { role: "patient", login, password });
    saveSession(resp);
    location.reload();
  };

  el("#chooseBtn").onclick = async () => {
    const sess = loadSession();
    const did = parseInt($doctorSelect.value, 10);
    await api("/api/patient/select-doctor", "POST", { patient_id: sess.id, doctor_id: did });
    await renderMe(sess.id);
    alert("Выбор сохранён.");
  };
})();
</script>
</body>
</html>