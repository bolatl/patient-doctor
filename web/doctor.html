<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Кабинет врача</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 40px; background: #fafafa; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 24px; max-width: 480px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .row { display: flex; gap: 12px; align-items: center; margin-bottom: 10px; }
    label { width: 100px; font-weight: 500; }
    input { flex: 1; padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; }
    h2 { margin-top: 0; }
    button, .btn-secondary {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.15s ease;
    }
    button {
      background: #111;
      color: #fff;
    }
    button:hover { background: #222; }
    .btn-secondary {
      background: #f4f4f4;
      border: 1px solid #ccc;
      color: #222;
    }
    .btn-secondary:hover {
      background: #e9e9e9;
    }
    .muted { color: #666; font-size: 14px; margin-top: 10px; }
    ul { padding-left: 18px; }
  </style>
  <script src="app.js"></script>
</head>
<body>
  <div class="card">
    <h2>Кабинет врача</h2>
    <div id="login">
      <div class="row"><label>Логин</label><input id="loginInput" value="cardio"></div>
      <div class="row"><label>Пароль</label><input id="passInput" type="password" value="1234"></div>
      <div class="row" style="gap:8px;">
        <button id="loginBtn">Войти</button>
        <a href="patient.html" class="btn-secondary" style="text-decoration:none; display:inline-block; padding:8px 14px;">Я пациент</a>
      </div>
      <p class="muted">Тестовые учётки: cardio/1234 (ID 101) или neuro/1234 (ID 102)</p>
    </div>

    <div id="panel" style="display:none">
      <p><b id="dname"></b> — <span id="dspec"></span> <button onclick="logout()">Выйти</button></p>
      <h3>Список пациентов (обновляется в реальном времени)</h3>
      <ul id="plist"></ul>
      <p class="muted">Если пациент выберет вас — список обновится автоматически (SSE).</p>
    </div>
  </div>

<script>
(async function(){
  const $login = el("#login"), $panel = el("#panel");
  const $plist = el("#plist");

  function renderPatients(items){
    $plist.innerHTML = "";
    if(!items.length){ $plist.innerHTML = "<li class='muted'>Пока пусто</li>"; return; }
    items.forEach(p => {
      const li = document.createElement("li");
      li.textContent = `${p.name} (ID ${p.id})`;
      $plist.appendChild(li);
    });
  }

  async function loadDoctor(id){
    const resp = await api(`/api/doctor?id=${id}`);
    const d = resp.doctor;
    el("#dname").textContent = `${d.last_name} ${d.first_name} ${d.middle_name} (ID ${d.id})`;
    el("#dspec").textContent = d.speciality;
    renderPatients(resp.patients);
  }

  function connectSSE(id){
    const es = new EventSource(`/api/doctor/stream?id=${id}`);
    es.addEventListener("update", async () => {
      const resp = await api(`/api/doctor?id=${id}`);
      renderPatients(resp.patients);
    });
  }

  const sess = loadSession();
  if(sess && sess.role === "doctor"){
    $login.style.display = "none"; $panel.style.display = "";
    await loadDoctor(sess.id);
    connectSSE(sess.id);
  }

  el("#loginBtn").onclick = async () => {
    const login = el("#loginInput").value.trim();
    const password = el("#passInput").value.trim();
    const resp = await api("/api/login", "POST", { role: "doctor", login, password });
    saveSession(resp);
    location.reload();
  };
})();
</script>
</body>
</html>
